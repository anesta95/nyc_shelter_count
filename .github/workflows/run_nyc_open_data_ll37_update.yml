name: nyc_open_data_ll37_runner

on:
  schedule:
    - cron: '48 1 * * 1' # 1:48 UTC everyday
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  scheduled:
    # The type of runner that the job will run on
    runs-on: macOS-latest
    env:
        RENV_PATHS_ROOT: ~/Library/Application Support/renv
    steps:
      # Checks-out your repository
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT }}
        persist-credentials: false
        fetch-depth: 0

    - name: setup-r
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.2.3'
    # install renv package
    - run: |-
        R -e 'install.packages("renv")'
        R -e 'renv::upgrade(project = ".", reload = T, prompt = F)'
    # set up cache
    - name: Cache packages
      uses: actions/cache@v3
      with:
          path: ${{ env.RENV_PATHS_ROOT }}
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |-
            ${{ runner.os }}-renv-
    - run: R -e 'renv::restore()'
    # execute Rscript
    - run: Rscript families_with_children.R
      # env:
      #   SCT_PW: ${{ secrets.SCT_PW }}
    # push to git repo
    - name: Commit and push if it changed
    run: |-
      git config user.name "Automated"
      git config user.email "actions@users.noreply.github.com"
      git add -A
      timestamp=$(date -u)
      git commit -m "Latest data: ${timestamp}" || exit 0
    - name: Push changes
      uses: ad-m/github-push-action@master
      with: 
        github_token: ${{ secrets.PAT }} 
        branch: main